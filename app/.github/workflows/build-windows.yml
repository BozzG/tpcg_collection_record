name: ğŸªŸ Build Windows App

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  build-windows:
    name: ğŸ”¨ æ„å»ºWindowsåº”ç”¨
    runs-on: windows-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: ğŸ”§ è®¾ç½®Flutterç¯å¢ƒ
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“‹ æ£€æŸ¥Flutterç¯å¢ƒ
      run: |
        flutter --version
        flutter doctor -v
        
    - name: ğŸ”Œ å¯ç”¨Windowsæ¡Œé¢æ”¯æŒ
      run: flutter config --enable-windows-desktop
      
    - name: ğŸ“¦ è·å–é¡¹ç›®ä¾èµ–
      working-directory: ./app
      run: |
        flutter clean
        flutter pub get
        flutter pub deps
      
    - name: ğŸ” ä»£ç åˆ†æ
      working-directory: ./app
      run: flutter analyze --no-fatal-infos
      continue-on-error: true
      
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      working-directory: ./app
      run: flutter test
      continue-on-error: true
      
    - name: ğŸ”¨ æ„å»ºWindowsåº”ç”¨
      working-directory: ./app
      run: |
        $buildType = "${{ github.event.inputs.release_type || 'release' }}"
        Write-Host "æ„å»ºç±»å‹: $buildType"
        flutter build windows --$buildType --verbose
        
    - name: ğŸ“Š è·å–æ„å»ºä¿¡æ¯
      working-directory: ./app
      run: |
        $exePath = "build\windows\x64\runner\Release\tpcg_collection_record.exe"
        if (Test-Path $exePath) {
          $fileInfo = Get-Item $exePath
          $fileSize = $fileInfo.Length
          $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
          $creationTime = $fileInfo.CreationTime
          
          Write-Host "âœ… æ„å»ºæˆåŠŸï¼"
          Write-Host "ğŸ“ æ–‡ä»¶è·¯å¾„: $exePath"
          Write-Host "ğŸ“Š æ–‡ä»¶å¤§å°: $fileSizeMB MB"
          Write-Host "ğŸ• åˆ›å»ºæ—¶é—´: $creationTime"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "BUILD_SIZE=$fileSizeMB MB" >> $env:GITHUB_ENV
          echo "BUILD_SUCCESS=true" >> $env:GITHUB_ENV
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥ï¼æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          echo "BUILD_SUCCESS=false" >> $env:GITHUB_ENV
          exit 1
        }
      shell: pwsh
      
    - name: ğŸ“ åˆ›å»ºå‘å¸ƒåŒ…
      if: env.BUILD_SUCCESS == 'true'
      working-directory: ./app
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path "release-package"
        
        # å¤åˆ¶æ‰€æœ‰å¿…éœ€æ–‡ä»¶
        Copy-Item -Path "build\windows\x64\runner\Release\*" -Destination "release-package\" -Recurse -Force
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        $versionInfo = @"
TPCG Collection Record - Windowsç‰ˆæœ¬
æ„å»ºæ—¶é—´: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
æ„å»ºç‰ˆæœ¬: ${{ github.sha }}
åº”ç”¨å¤§å°: ${{ env.BUILD_SIZE }}
Flutterç‰ˆæœ¬: ${{ env.FLUTTER_VERSION }}

ä½¿ç”¨è¯´æ˜:
1. åŒå‡» tpcg_collection_record.exe è¿è¡Œåº”ç”¨
2. ç¡®ä¿æ‰€æœ‰æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹
3. å¦‚é‡é—®é¢˜ï¼Œè¯·æ£€æŸ¥Windowsç‰ˆæœ¬å…¼å®¹æ€§

é¡¹ç›®åœ°å€: ${{ github.server_url }}/${{ github.repository }}
"@
        $versionInfo | Out-File -FilePath "release-package\VERSION.txt" -Encoding UTF8
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        $launchScript = @"
@echo off
chcp 65001 >nul
echo ğŸš€ å¯åŠ¨ TPCG Collection Record...
echo.
if exist "tpcg_collection_record.exe" (
    start "" "tpcg_collection_record.exe"
) else (
    echo âŒ æœªæ‰¾åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼
    pause
)
"@
        $launchScript | Out-File -FilePath "release-package\å¯åŠ¨åº”ç”¨.bat" -Encoding Default
        
        Write-Host "ğŸ“¦ å‘å¸ƒåŒ…åˆ›å»ºå®Œæˆ"
      shell: pwsh
      
    - name: ğŸ“¤ ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
      if: env.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tpcg-collection-record-windows-${{ github.run_number }}
        path: ./app/release-package/
        retention-days: 30
        compression-level: 6
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºæ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          ./app/build/
          !./app/build/windows/x64/runner/Release/
        retention-days: 7
        
    - name: ğŸ“ åˆ›å»ºRelease (ä»…æ ‡ç­¾æ¨é€)
      if: startsWith(github.ref, 'refs/tags/v') && env.BUILD_SUCCESS == 'true'
      uses: softprops/action-gh-release@v1
      with:
        files: ./app/release-package/*
        name: TPCG Collection Record ${{ github.ref_name }}
        body: |
          ## ğŸªŸ Windowsç‰ˆæœ¬å‘å¸ƒ
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æ„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          - **åº”ç”¨å¤§å°**: ${{ env.BUILD_SIZE }}
          - **Flutterç‰ˆæœ¬**: ${{ env.FLUTTER_VERSION }}
          
          ### ğŸ“¦ å®‰è£…è¯´æ˜
          1. ä¸‹è½½ `tpcg-collection-record-windows-${{ github.run_number }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `tpcg_collection_record.exe` è¿è¡Œ
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸƒ å¡ç‰‡æ”¶è—ç®¡ç†
          - ğŸ“ é¡¹ç›®åˆ†ç±»ç»„ç»‡
          - ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆå’Œç¼©æ”¾
          - ğŸ“Š ç»Ÿè®¡å’Œåˆ†æ
          - ğŸ’¾ æœ¬åœ°æ•°æ®å­˜å‚¨
          
          ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
          - Windows 10 1903 æˆ–æ›´é«˜ç‰ˆæœ¬
          - x64 æ¶æ„å¤„ç†å™¨
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}