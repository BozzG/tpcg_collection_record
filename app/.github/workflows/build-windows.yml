name: Build Windows App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        
    - name: ğŸ“‹ Flutter doctor
      run: flutter doctor -v
      
    - name: ğŸ”Œ Enable Windows desktop
      run: flutter config --enable-windows-desktop
      
    - name: ğŸ“¦ Get dependencies
      working-directory: ./app
      run: flutter pub get
      
    - name: ğŸ”¨ Build Windows app
      working-directory: ./app
      run: flutter build windows --release
      
    - name: ğŸ“ Create release package
      working-directory: ./app
      run: |
        mkdir release-package
        xcopy "build\windows\x64\runner\Release\*" "release-package\" /E /I /H /Y
        
    - name: ğŸ“Š Get build info
      working-directory: ./app
      run: |
        $exePath = "build\windows\x64\runner\Release\tpcg_collection_record.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length
          $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
          Write-Host "Build successful! Size: $fileSizeMB MB"
        }
      shell: pwsh
      
    - name: ğŸ“¤ Upload Windows build
      uses: actions/upload-artifact@v4
      with:
        name: windows-app-${{ github.sha }}
        path: ./app/release-package/
        retention-days: 30
        
    - name: ğŸ“¤ Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          ./app/build/
          !./app/build/windows/x64/runner/Release/
        retention-days: 7